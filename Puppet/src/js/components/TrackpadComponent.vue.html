<template>
    <div 
        class="trackpad"
        ref="trackpad"
    >
        <touch
            :handler="touchHandler"
        >
            <canvas
                ref="canvas"
                :width="width"
                :height="height"
            ></canvas>
        </touch>
    </div>
</template>

<script>
    const lerp = require('lerp')
    const client = require('../utilities/SocketClient.js');

    export default {
        data() {
            return {
                ctx: null,
                data: null,
                loop: null,
                alpha: 1,
                width: 0,
                height: 0,
                scroll: false,
                touching: false
            }
        },
        mounted() {
            this.ctx = this.$refs.canvas.getContext('2d');
            this.loop = setInterval(this.draw, 16);
            this.resize();

            window.addEventListener('resize', this.resize);

            console.log("Trackpad Component mounted.");
        },
        methods: {
            resize() {
                console.log("Trackpad Component - Resizing.");

                this.width = this.$refs.trackpad.clientWidth;
                this.height = this.$refs.trackpad.clientHeight;
            },
            touchHandler(data) {
                this.data = data;

                this.scroll = this.data.px.x > this.width - 49.5;
            },
            draw() {
                // Clear the canvas
                this.ctx.clearRect(0, 0, this.width, this.height);
                // Update the internal alpha value
                this.updateAlpha();

                // If there is a touch event currently... darken the side being touched
                if (this.side != null) {
                    this.ctx.globalAlpha = this.alpha;
                    this.ctx.fillStyle = '#57606f';
                    if (this.scroll) {
                        this.ctx.fillRect(this.width - 49.5, 0, 49.5, this.height);
                    }
                    else {
                        this.ctx.fillRect(0, 0, this.width - 49.5, this.height);
                    }
                }

                // Draw the left/right divider
                this.ctx.beginPath();
                this.ctx.globalAlpha = 1;
                this.ctx.strokeStyle = '#57606f';
                this.ctx.moveTo(this.width - 49.5, 0);
                this.ctx.lineTo(this.width - 49.5, this.height);
                this.ctx.stroke();

                this.drawCursor();


            },
            drawCursor() {
                // Draw the cursor icon, if there is a touch event going on...
                if (this.data != null) {
                    // Draw an icon where the user it touching
                    this.ctx.fillStyle = (this.scroll ? '#7bed9f' : '#70a1ff');
                    this.ctx.globalAlpha = this.alpha;
                    this.ctx.beginPath();
                    this.ctx.arc(this.data.px.x, this.data.px.y, 25, 0, 2 * Math.PI);
                    this.ctx.fill();
                }
            },
            updateAlpha() {
                if (this.data != null && this.data.touching) {
                    this.alpha = lerp(1, this.alpha, 0.15);
                }
                else {
                    this.alpha = lerp(this.alpha, 0, 0.1);
                }
            }
        }
    }
</script>